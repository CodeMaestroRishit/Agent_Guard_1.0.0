import json
import os
import sys
import time
import uuid
from typing import Any

import requests

PORT = os.getenv("PORT", "5073")
API_URL = f"http://localhost:{PORT}/enforce"
SIM_DELAY = float(os.getenv("SIM_DELAY", "1"))
SIM_COUNT = int(os.getenv("SIM_COUNT", "10"))


def simulate(agent_id: str, roles: list[str], tool_id: str, params: dict[str, Any]) -> None:
    payload = {
        "agent_id": agent_id,
        "agent_roles": roles,
        "tool_id": tool_id,
        # tool_version kept explicit so server-side defaults remain deterministic
        "tool_version": os.environ.get("TOOL_VERSION", "1.0"),
        "params": params,
        "request_id": str(uuid.uuid4()),
    }
    try:
        response = requests.post(API_URL, json=payload, timeout=5)
    except requests.RequestException as exc:
        print(f"[error] Failed to reach enforcement API at {API_URL}: {exc}")
        sys.exit(1)

    try:
        body = response.json()
        print(json.dumps({"status": response.status_code, "body": body}, indent=2))
    except ValueError:
        print(json.dumps({"status": response.status_code, "body": response.text}, indent=2))


if __name__ == "__main__":
    for i in range(SIM_COUNT):
        simulate("agent-reader", ["reader"], "read_logs", {"limit": (i % 10) + 1})
        time.sleep(SIM_DELAY)
